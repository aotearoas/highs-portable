name: Build Portable Binaries
on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: ERGO-Code/HiGHS
          ref: v1.7.0
          path: highs-tmp

      - name: Move HiGHS source (skip .git/.github)
        shell: bash
        run: |
          for item in highs-tmp/* highs-tmp/.[!.]* highs-tmp/..?*; do
            [[ -e "$item" ]] || continue
            case $(basename "$item") in .git|.github) continue;; esac
            mv "$item" .
          done
          rm -rf highs-tmp

      - name: Configure & Build
        run: |
          cmake --preset static-${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}
          cmake --build --preset ${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}

      - name: Strip & pack
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            BIN=$(find build-static-win -name highs.exe)
            strip "$BIN"
            upx -9 "$BIN" || true
            7z a highs-portable-win64.zip "$BIN"
            echo "ART=highs-portable-win64.zip" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            BIN=$(find build-static-macos -name highs)
            strip "$BIN"
            tar -czf highs-portable-macos-universal.tar.gz -C $(dirname "$BIN") $(basename "$BIN")
            echo "ART=highs-portable-macos-universal.tar.gz" >> $GITHUB_ENV

          else  # Linux
            BIN=$(find build-static-linux -name highs)
            clang++ -static -s -o highs-static "$BIN" build-static-linux/lib/libhighs.a -lm -lpthread
            strip -s highs-static
            upx -9 highs-static || true
            tar -czf highs-portable-linux-x86_64.tar.gz highs-static
            echo "ART=highs-portable-linux-x86_64.tar.gz" >> $GITHUB_ENV
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ART }}
          path: ${{ env.ART }}"

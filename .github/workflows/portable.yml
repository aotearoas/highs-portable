name: Build Portable Binaries
on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/checkout@v4
        with:
          repository: ERGO-Code/HiGHS
          ref: v1.7.0
          path: highs-tmp

      - name: Move HiGHS source (skip .git/.github)
        shell: bash
        run: |
          for item in highs-tmp/* highs-tmp/.[!.]* highs-tmp/..?*; do
            [[ -e "$item" ]] || continue
            case $(basename "$item") in .git|.github) continue;; esac
            mv "$item" .
          done
          rm -rf highs-tmp

      - name: Configure & Build
        run: |
          cmake --preset static-${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}
          cmake --build --preset ${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}

      - name: Static link & strip **only** highs binary
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            gcc -static -s -o highs-static.exe \
              build-static-win/bin/highs \
              build-static-win/lib/libhighs.a \
              -lkernel32 -luser32 -lgdi32 -lwinspool -lshell32 -lole32 -loleaut32 -luuid -lcomdlg32 -ladvapi32
            strip highs-static.exe && upx -9 highs-static.exe || true
            7z a highs-portable-win64.zip highs-static.exe
            echo "ART=highs-portable-win64.zip" >> $GITHUB_ENV

          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            clang++ -static -s -o highs-static \
              build-static-macos/bin/highs \
              build-static-macos/lib/libhighs.a \
              -lm -lpthread
            strip highs-static
            tar -czf highs-portable-macos-universal.tar.gz highs-static
            echo "ART=highs-portable-macos-universal.tar.gz" >> $GITHUB_ENV

          else
            clang++ -static -s -o highs-static \
              build-static-linux/bin/highs \
              build-static-linux/lib/libhighs.a \
              -lm -lpthread
            strip -s highs-static
            upx -9 highs-static || true
            tar -czf highs-portable-linux-x86_64.tar.gz highs-static
            echo "ART=highs-portable-linux-x86_64.tar.gz" >> $GITHUB_ENV
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ART }}
          path: ${{ env.ART }}

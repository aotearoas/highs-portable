name: Build Portable Binaries
on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      # 1. 先检出自己的仓库（含 CMakePresets.json）
      - uses: actions/checkout@v4

      # 2. 再拉 HiGHS 源码到临时目录
      - uses: actions/checkout@v4
        with:
          repository: ERGO-Code/HiGHS
          ref: v1.7.0
          path: highs-tmp

      # 3. 把 HiGHS 文件挪到根目录（保留自己的 CMakePresets.json）
      - name: Move HiGHS source
        shell: bash
        run: |
          shopt -s dotglob
          mv highs-tmp/* .
          rm -rf highs-tmp

      # 4. 编译 & 打包
      - name: Configure & Build
        run: |
          cmake --preset static-${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}
          cmake --build --preset ${{ runner.os == 'Windows' && 'win' || runner.os == 'macOS' && 'macos' || 'linux' }}

      - name: Strip & Pack
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            strip build-static-win/bin/highs.exe
            upx -9 build-static-win/bin/highs.exe || true
            7z a highs-portable-win64.zip build-static-win/bin/highs.exe
            echo "ART=highs-portable-win64.zip" >> $GITHUB_ENV
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            strip build-static-macos/bin/highs
            tar -czf highs-portable-macos-universal.tar.gz -C build-static-macos/bin highs
            echo "ART=highs-portable-macos-universal.tar.gz" >> $GITHUB_ENV
          else
            strip -s build-static-linux/bin/highs
            upx -9 build-static-linux/bin/highs || true
            tar -czf highs-portable-linux-x86_64.tar.gz -C build-static-linux/bin highs
            echo "ART=highs-portable-linux-x86_64.tar.gz" >> $GITHUB_ENV
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ART }}
          path: ${{ env.ART }}
